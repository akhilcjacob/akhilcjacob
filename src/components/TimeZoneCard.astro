---
import Card from "./Card/index.astro";

// Function to get latest blog post from Hashnode API
async function getLatestPost() {
  try {
    const query = `
      query GetLatestPost {
        publication(host: "engineering.akhilcjacob.com") {
          posts(first: 1) {
            edges {
              node {
                title
                slug
                brief
                publishedAt
                url
              }
            }
          }
        }
      }
    `;

    const response = await fetch('https://gql.hashnode.com/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ query })
    });

    const data = await response.json();
    const post = data.data?.publication?.posts?.edges?.[0]?.node;

    if (post) {
      return {
        title: post.title,
        slug: post.slug,
        description: post.brief?.substring(0, 50) + '...' || 'No description',
        url: post.url,
        date: post.publishedAt
      };
    }

    throw new Error('No posts found');
  } catch (error) {
    // Fallback to static data if API fails
    return {
      title: "Building InboxHiiv",
      slug: "building-inboxhiive",
      description: "Event-driven podcast processing with Firebase & AI",
      url: "https://engineering.akhilcjacob.com/building-inboxhiive",
      date: "Recent"
    };
  }
}

const latestPost = await getLatestPost();

// Split title at colon for better display
const titleParts = latestPost.title.split(':');
const mainTitle = titleParts[0].trim();
const subtitle = titleParts.length > 1 ? titleParts[1].trim() : null;
---

<Card colSpan="col-span-1" rowSpan="row-span-1"
class={`min-h-[10px] md:min-h-0`}
>
  <div class="flex flex-col justify-center h-full">
    <!-- Header with green dot -->
    <div class="flex items-center justify-between mb-3">
      <span class="text-xs text-white/50 tracking-wider">LATEST POST</span>
      <div class="w-2 h-2 bg-green-400 rounded-full"></div>
    </div>
    
    <!-- Main content - left justified -->
    <a href={latestPost.url || `https://engineering.akhilcjacob.com/${latestPost.slug}`}
       target="_blank"
       rel="noopener noreferrer"
       class="block mb-2 group text-left cursor-pointer hover:bg-white/5 rounded-lg p-2 -m-2 transition-all">
      <h3 class="text-base font-bold text-white/90 group-hover:text-white transition-colors leading-tight mb-2 sm:text-sm">
        {mainTitle}
      </h3>
      {subtitle && (
        <p class="text-xs text-white/60 group-hover:text-white/70 leading-relaxed transition-colors sm:text-[10px]">
          {subtitle}
        </p>
      )}
    </a>
    
    <!-- Footer -->
    <a href="https://engineering.akhilcjacob.com" 
       target="_blank"
       rel="noopener noreferrer"
       class="text-xs text-blue-300 hover:text-blue-200 transition-colors text-center rounded-lg bg-white/10 px-3 py-2 hover:bg-white/15 sm:px-2 sm:py-1 sm:text-[10px]">
      View Engineering Notes â†’
    </a>
  </div>
</Card>